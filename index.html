<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ç–µ–ª–∞ —á–µ—Ä–µ–∑ –∫–∞–º–µ—Ä—É</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .container {
            max-width: 900px;
            width: 100%;
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
        }
        
        .video-container {
            position: relative;
            width: 100%;
            margin-bottom: 20px;
        }
        
        #video {
            width: 100%;
            max-width: 640px;
            height: 480px;
            border-radius: 10px;
            background: #000;
            transform: scaleX(-1); /* –ó–µ—Ä–∫–∞–ª—å–Ω–æ–µ –æ—Ç—Ä–∞–∂–µ–Ω–∏–µ */
        }
        
        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            max-width: 640px;
            height: 480px;
            pointer-events: none;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            background: #4CAF50;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        button:hover {
            background: #45a049;
            transform: translateY(-2px);
        }
        
        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        
        #stopButton {
            background: #f44336;
        }
        
        #stopButton:hover {
            background: #da190b;
        }
        
        .info-panel {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        #info {
            font-size: 16px;
            line-height: 1.5;
            color: #333;
        }
        
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
            font-weight: bold;
        }
        
        .loading {
            background: #fff3cd;
            color: #856404;
        }
        
        .success {
            background: #d1edff;
            color: #004085;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            #video, #canvas {
                height: 400px;
            }
        }
        
        @media (max-width: 480px) {
            #video, #canvas {
                height: 300px;
            }
            
            button {
                padding: 10px 20px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üï∫ –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ç–µ–ª–∞ –∏ –∫–æ–Ω–µ—á–Ω–æ—Å—Ç–µ–π</h1>
        
        <div class="video-container">
            <video id="video" autoplay playsinline></video>
            <canvas id="canvas"></canvas>
        </div>
        
        <div class="controls">
            <button id="startButton">üé• –í–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É</button>
            <button id="stopButton" disabled>‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
            <button id="screenshotButton" disabled>üì∏ –°–¥–µ–ª–∞—Ç—å —Å–Ω–∏–º–æ–∫</button>
        </div>
        
        <div id="status" class="status loading">
            ‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–µ–π—Ä–æ—Å–µ—Ç–∏...
        </div>
        
        <div class="info-panel">
            <div id="info">
                –ù–∞–∂–º–∏—Ç–µ "–í–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É" –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>
    
    <script>
        // –≠–ª–µ–º–µ–Ω—Ç—ã —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const screenshotButton = document.getElementById('screenshotButton');
        const status = document.getElementById('status');
        const info = document.getElementById('info');
        
        let detector;
        let isDetecting = false;
        let animationId;

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
        function updateStatus(message, type = 'loading') {
            status.textContent = message;
            status.className = `status ${type}`;
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–µ—Ç–µ–∫—Ç–æ—Ä–∞ –ø–æ–∑
        async function initPoseDetector() {
            try {
                updateStatus('üöÄ –ó–∞–≥—Ä—É–∑–∫–∞ TensorFlow.js...');
                await tf.ready();
                
                updateStatus('üì¶ –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –ø–æ–∑...');
                const model = poseDetection.SupportedModels.MoveNet;
                detector = await poseDetection.createDetector(model, {
                    modelType: poseDetection.movenet.modelType.SINGLEPOSE_LIGHTNING,
                });
                
                updateStatus('‚úÖ –ú–æ–¥–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω–∞!', 'success');
                startButton.disabled = false;
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
                updateStatus('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–∏: ' + error.message, 'error');
            }
        }

        // –ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã
        async function setupCamera() {
            try {
                updateStatus('üì∑ –ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ...');
                
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: 'user' 
                    } 
                });
                
                video.srcObject = stream;
                
                return new Promise((resolve) => {
                    video.onloadedmetadata = () => {
                        video.play();
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        resolve(video);
                    };
                });
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã:', error);
                updateStatus('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ', 'error');
                throw error;
            }
        }

        // –†–∞—Å—á–µ—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –º–µ–∂–¥—É —Ç–æ—á–∫–∞–º–∏
        function calculateDistance(point1, point2) {
            const dx = point1.x - point2.x;
            const dy = point1.y - point2.y;
            return Math.sqrt(dx * dx + dy * dy) * 100; // –í —É—Å–ª–æ–≤–Ω—ã—Ö –µ–¥–∏–Ω–∏—Ü–∞—Ö
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–∫–µ–ª–µ—Ç–∞
        function drawSkeleton(keypoints) {
            // –°–æ–µ–¥–∏–Ω–µ–Ω–∏—è –º–µ–∂–¥—É —Ç–æ—á–∫–∞–º–∏ (—Å–∫–µ–ª–µ—Ç)
            const connections = [
                // –†—É–∫–∏
                [5, 7], [7, 9],     // –õ–µ–≤–∞—è —Ä—É–∫–∞
                [6, 8], [8, 10],    // –ü—Ä–∞–≤–∞—è —Ä—É–∫–∞
                // –¢–µ–ª–æ
                [5, 6], [5, 11], [6, 12], [11, 12],
                // –ù–æ–≥–∏
                [11, 13], [13, 15], // –õ–µ–≤–∞—è –Ω–æ–≥–∞
                [12, 14], [14, 16]  // –ü—Ä–∞–≤–∞—è –Ω–æ–≥–∞
            ];

            // –†–∏—Å—É–µ–º –ª–∏–Ω–∏–∏
            ctx.strokeStyle = '#00FF00';
            ctx.lineWidth = 3;

            connections.forEach(([i, j]) => {
                const kp1 = keypoints[i];
                const kp2 = keypoints[j];
                
                if (kp1.score > 0.3 && kp2.score > 0.3) {
                    ctx.beginPath();
                    ctx.moveTo(kp1.x * canvas.width, kp1.y * canvas.height);
                    ctx.lineTo(kp2.x * canvas.width, kp2.y * canvas.height);
                    ctx.stroke();
                }
            });

            // –†–∏—Å—É–µ–º —Ç–æ—á–∫–∏
            keypoints.forEach((keypoint, index) => {
                if (keypoint.score > 0.3) {
                    const x = keypoint.x * canvas.width;
                    const y = keypoint.y * canvas.height;
                    
                    ctx.beginPath();
                    ctx.arc(x, y, 5, 0, 2 * Math.PI);
                    ctx.fillStyle = '#FF0000';
                    ctx.fill();
                    
                    // –ü–æ–¥–ø–∏—Å–∏ –¥–ª—è –∫–ª—é—á–µ–≤—ã—Ö —Ç–æ—á–µ–∫
                    if (index <= 10) {
                        ctx.fillStyle = '#FFFFFF';
                        ctx.font = '12px Arial';
                        ctx.fillText(index.toString(), x + 8, y - 8);
                    }
                }
            });
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–π
        function drawDistances(keypoints) {
            ctx.strokeStyle = '#FF00FF';
            ctx.lineWidth = 2;
            ctx.font = '14px Arial';
            ctx.fillStyle = '#FFFF00';

            // –í–∞–∂–Ω—ã–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
            const distances = [
                { points: [5, 6], label: '–ü–ª–µ—á–∏' },      // –ü–ª–µ—á–∏
                { points: [9, 10], label: '–ö–∏—Å—Ç–∏' },     // –ö–∏—Å—Ç–∏ —Ä—É–∫
                { points: [5, 9], label: '–õ–µ–≤–∞—è —Ä—É–∫–∞' }, // –õ–µ–≤–∞—è —Ä—É–∫–∞
                { points: [6, 10], label: '–ü—Ä–∞–≤–∞—è —Ä—É–∫–∞' }, // –ü—Ä–∞–≤–∞—è —Ä—É–∫–∞
                { points: [11, 12], label: '–ë–µ–¥—Ä–∞' },    // –ë–µ–¥—Ä–∞
                { points: [11, 15], label: '–õ–µ–≤–∞—è –Ω–æ–≥–∞' }, // –õ–µ–≤–∞—è –Ω–æ–≥–∞
                { points: [12, 16], label: '–ü—Ä–∞–≤–∞—è –Ω–æ–≥–∞' } // –ü—Ä–∞–≤–∞—è –Ω–æ–≥–∞
            ];

            distances.forEach(({ points: [i, j], label }) => {
                const kp1 = keypoints[i];
                const kp2 = keypoints[j];
                
                if (kp1 && kp2 && kp1.score > 0.3 && kp2.score > 0.3) {
                    const x1 = kp1.x * canvas.width;
                    const y1 = kp1.y * canvas.height;
                    const x2 = kp2.x * canvas.width;
                    const y2 = kp2.y * canvas.height;
                    
                    // –†–∏—Å—É–µ–º –ª–∏–Ω–∏—é —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è
                    ctx.setLineDash([5, 5]);
                    ctx.beginPath();
                    ctx.moveTo(x1, y1);
                    ctx.lineTo(x2, y2);
                    ctx.stroke();
                    ctx.setLineDash([]);
                    
                    // –ü–æ–¥–ø–∏—Å—å —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è
                    const midX = (x1 + x2) / 2;
                    const midY = (y1 + y2) / 2;
                    const distance = calculateDistance(kp1, kp2).toFixed(1);
                    
                    ctx.fillText(`${label}: ${distance}`, midX, midY);
                }
            });
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
        function updateInfo(keypoints) {
            let infoText = 'üï∫ –¢–µ–ª–æ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ!\n\n';
            
            // –û—Å–Ω–æ–≤–Ω—ã–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è
            const distances = [
                { points: [5, 6], label: 'üìè –®–∏—Ä–∏–Ω–∞ –ø–ª–µ—á' },
                { points: [9, 10], label: 'üëê –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –∫–∏—Å—Ç—è–º–∏' },
                { points: [11, 12], label: 'ü¶µ –®–∏—Ä–∏–Ω–∞ –±–µ–¥–µ—Ä' }
            ];
            
            distances.forEach(({ points: [i, j], label }) => {
                const kp1 = keypoints[i];
                const kp2 = keypoints[j];
                
                if (kp1 && kp2 && kp1.score > 0.3 && kp2.score > 0.3) {
                    const distance = calculateDistance(kp1, kp2).toFixed(1);
                    infoText += `${label}: ${distance} –µ–¥.\n`;
                }
            });
            
            // –ü–æ–¥—Å—á–µ—Ç –≤–∏–¥–∏–º—ã—Ö —Ç–æ—á–µ–∫
            const visiblePoints = keypoints.filter(kp => kp.score > 0.3).length;
            infoText += `\nüìä –í–∏–¥–∏–º—ã—Ö —Ç–æ—á–µ–∫: ${visiblePoints}/17`;
            
            info.textContent = infoText;
        }

        // –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
        async function detectPose() {
            if (!isDetecting) return;
            
            try {
                // –û—á–∏—â–∞–µ–º canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // –†–∞—Å–ø–æ–∑–Ω–∞–µ–º –ø–æ–∑—É
                const poses = await detector.estimatePoses(video);
                
                if (poses.length > 0) {
                    const pose = poses[0];
                    const keypoints = pose.keypoints;
                    
                    // –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Å–∫–µ–ª–µ—Ç –∏ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è
                    drawSkeleton(keypoints);
                    drawDistances(keypoints);
                    updateInfo(keypoints);
                    
                    updateStatus('‚úÖ –¢–µ–ª–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç—Å—è', 'success');
                } else {
                    info.textContent = '‚ùå –¢–µ–ª–æ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ. –í—Å—Ç–∞–Ω—å—Ç–µ –ø–µ—Ä–µ–¥ –∫–∞–º–µ—Ä–æ–π.';
                    updateStatus('üîç –ü–æ–∏—Å–∫ —Ç–µ–ª–∞...', 'loading');
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è:', error);
                updateStatus('‚ùå –û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è', 'error');
            }
            
            // –°–ª–µ–¥—É—é—â–∏–π –∫–∞–¥—Ä
            animationId = requestAnimationFrame(detectPose);
        }

        // –°–Ω–∏–º–æ–∫ —ç–∫—Ä–∞–Ω–∞
        function takeScreenshot() {
            const link = document.createElement('a');
            link.download = 'body-tracking-screenshot.png';
            link.href = canvas.toDataURL();
            link.click();
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        startButton.addEventListener('click', async () => {
            try {
                startButton.disabled = true;
                await setupCamera();
                
                stopButton.disabled = false;
                screenshotButton.disabled = false;
                isDetecting = true;
                
                updateStatus('üéØ –ù–∞—á–∞–ª–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è...', 'success');
                detectPose();
                
            } catch (error) {
                startButton.disabled = false;
            }
        });

        stopButton.addEventListener('click', () => {
            isDetecting = false;
            cancelAnimationFrame(animationId);
            
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            startButton.disabled = false;
            stopButton.disabled = true;
            screenshotButton.disabled = true;
            
            info.textContent = '–ö–∞–º–µ—Ä–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞. –ù–∞–∂–º–∏—Ç–µ "–í–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É" –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è.';
            updateStatus('‚èπÔ∏è –ö–∞–º–µ—Ä–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞', 'loading');
        });

        screenshotButton.addEventListener('click', takeScreenshot);

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('load', initPoseDetector);
    </script>
</body>
</html>