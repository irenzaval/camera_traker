<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MoveNet - –¢–æ—á–Ω–æ–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –ø–æ–∑—ã</title>
    <style>
        /* –°—Ç–∏–ª–∏ –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É –ø—Ä–∏–º–µ—Ä—É */
        body { margin: 0; padding: 20px; font-family: Arial; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 15px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        h1 { text-align: center; color: #333; margin-bottom: 20px; }
        .video-container { position: relative; width: 100%; max-width: 800px; margin: 0 auto; }
        #video { width: 100%; height: 500px; border-radius: 10px; background: #000; transform: scaleX(-1); }
        #canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        .controls { display: flex; gap: 10px; margin: 20px 0; justify-content: center; flex-wrap: wrap; }
        button { padding: 12px 24px; border: none; border-radius: 25px; background: #4CAF50; color: white; font-size: 16px; cursor: pointer; }
        button:hover { background: #45a049; transform: translateY(-2px); }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin: 20px 0; }
        .stat-card { background: #f8f9fa; padding: 15px; border-radius: 10px; text-align: center; }
        .stat-value { font-size: 24px; font-weight: bold; color: #333; }
        .stat-label { font-size: 14px; color: #666; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üèÉ MoveNet - –¢–æ—á–Ω–æ–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø–æ–∑—ã</h1>
        
        <div class="video-container">
            <video id="video" autoplay playsinline></video>
            <canvas id="canvas"></canvas>
        </div>
        
        <div class="controls">
            <button id="startButton">üé• –í–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É</button>
            <button id="stopButton" disabled>‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
            <button id="modeButton" disabled>üîÅ –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ä–µ–∂–∏–º</button>
        </div>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="fps">0</div>
                <div class="stat-label">FPS</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="points">0</div>
                <div class="stat-label">–¢–æ—á–µ–∫</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="confidence">0%</div>
                <div class="stat-label">–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å</div>
            </div>
        </div>
        
        <div id="status">–ó–∞–≥—Ä—É–∑–∫–∞ MoveNet –º–æ–¥–µ–ª–∏...</div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>

    <script>
        class MoveNetDetector {
            constructor() {
                this.video = document.getElementById('video');
                this.canvas = document.getElementById('canvas');
                this.ctx = this.canvas.getContext('2d');
                this.detector = null;
                this.isDetecting = false;
                this.animationId = null;
                this.currentModel = 'lite';
                
                this.stats = {
                    fps: document.getElementById('fps'),
                    points: document.getElementById('points'),
                    confidence: document.getElementById('confidence')
                };
                this.statusElement = document.getElementById('status');
                
                this.frameCount = 0;
                this.lastTime = performance.now();
            }

            async initialize() {
                try {
                    this.updateStatus('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è TensorFlow.js...');
                    
                    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –±—ç–∫–µ–Ω–¥–∞
                    await tf.setBackend('webgl');
                    await tf.ready();
                    
                    this.updateStatus('üì¶ –ó–∞–≥—Ä—É–∑–∫–∞ MoveNet –º–æ–¥–µ–ª–∏...');
                    
                    // –°–æ–∑–¥–∞–Ω–∏–µ –¥–µ—Ç–µ–∫—Ç–æ—Ä–∞ –ø–æ–∑—ã
                    const model = poseDetection.SupportedModels.MoveNet;
                    this.detector = await poseDetection.createDetector(model, {
                        modelType: poseDetection.movenet.modelType.SINGLEPOSE_LIGHTNING,
                        enableSmoothing: true
                    });
                    
                    this.updateStatus('‚úÖ MoveNet –∑–∞–≥—Ä—É–∂–µ–Ω! –ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ.', 'success');
                    document.getElementById('startButton').disabled = false;
                    
                } catch (error) {
                    this.updateStatus('‚ùå –û—à–∏–±–∫–∞: ' + error.message, 'error');
                }
            }

            updateStatus(message, type = 'info') {
                this.statusElement.textContent = message;
                this.statusElement.style.color = type === 'error' ? '#dc3545' : 
                                               type === 'success' ? '#28a745' : '#333';
            }

            async setupCamera() {
                try {
                    this.updateStatus('üì∑ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∫–∞–º–µ—Ä–µ...');
                    
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            width: { ideal: 640 },
                            height: { ideal: 480 },
                            facingMode: 'user'
                        }
                    });
                    
                    this.video.srcObject = stream;
                    
                    return new Promise((resolve) => {
                        this.video.onloadedmetadata = () => {
                            this.video.play();
                            this.canvas.width = this.video.videoWidth;
                            this.canvas.height = this.video.videoHeight;
                            resolve();
                        };
                    });
                    
                } catch (error) {
                    this.updateStatus('‚ùå –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ', 'error');
                    throw error;
                }
            }

            async detectPose() {
                if (!this.isDetecting) return;

                try {
                    // –û—Ü–µ–Ω–∫–∞ –ø–æ–∑—ã
                    const poses = await this.detector.estimatePoses(this.video, {
                        maxPoses: 1,
                        flipHorizontal: false
                    });

                    // –û—á–∏—Å—Ç–∫–∞ canvas
                    this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

                    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –≤–∏–¥–µ–æ
                    this.ctx.save();
                    this.ctx.scale(-1, 1);
                    this.ctx.drawImage(this.video, -this.canvas.width, 0, this.canvas.width, this.canvas.height);
                    this.ctx.restore();

                    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                    if (poses.length > 0) {
                        this.drawSkeleton(poses[0]);
                        this.updateStatistics(poses[0]);
                    }

                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è:', error);
                }

                // –†–∞—Å—á–µ—Ç FPS
                this.frameCount++;
                const currentTime = performance.now();
                if (currentTime - this.lastTime >= 1000) {
                    this.stats.fps.textContent = Math.round((this.frameCount * 1000) / (currentTime - this.lastTime));
                    this.frameCount = 0;
                    this.lastTime = currentTime;
                }

                this.animationId = requestAnimationFrame(() => this.detectPose());
            }

            drawSkeleton(pose) {
                const keypoints = pose.keypoints;
                let visiblePoints = 0;
                let totalConfidence = 0;

                // –¶–≤–µ—Ç–∞ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —á–∞—Å—Ç–µ–π —Ç–µ–ª–∞
                const colors = {
                    head: '#FF6B6B',
                    arms: '#4ECDC4', 
                    torso: '#45B7D1',
                    legs: '#96CEB4'
                };

                // –°–æ–µ–¥–∏–Ω–µ–Ω–∏—è
                const connections = [
                    // –ì–æ–ª–æ–≤–∞
                    { points: [0, 1], color: colors.head }, { points: [0, 2], color: colors.head },
                    { points: [1, 3], color: colors.head }, { points: [2, 4], color: colors.head },
                    // –†—É–∫–∏  
                    { points: [5, 7], color: colors.arms }, { points: [7, 9], color: colors.arms },
                    { points: [6, 8], color: colors.arms }, { points: [8, 10], color: colors.arms },
                    // –¢–æ—Ä—Å
                    { points: [5, 6], color: colors.torso }, { points: [5, 11], color: colors.torso },
                    { points: [6, 12], color: colors.torso }, { points: [11, 12], color: colors.torso },
                    // –ù–æ–≥–∏
                    { points: [11, 13], color: colors.legs }, { points: [13, 15], color: colors.legs },
                    { points: [12, 14], color: colors.legs }, { points: [14, 16], color: colors.legs }
                ];

                // –†–∏—Å—É–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
                connections.forEach(conn => {
                    const kp1 = keypoints[conn.points[0]];
                    const kp2 = keypoints[conn.points[1]];
                    
                    if (kp1.score > 0.3 && kp2.score > 0.3) {
                        this.ctx.beginPath();
                        this.ctx.moveTo(kp1.x, kp1.y);
                        this.ctx.lineTo(kp2.x, kp2.y);
                        this.ctx.strokeStyle = conn.color;
                        this.ctx.lineWidth = 4;
                        this.ctx.lineCap = 'round';
                        this.ctx.stroke();
                    }
                });

                // –†–∏—Å—É–µ–º —Ç–æ—á–∫–∏
                keypoints.forEach((kp, index) => {
                    if (kp.score > 0.2) {
                        visiblePoints++;
                        totalConfidence += kp.score;

                        const group = index <= 4 ? 'head' : 
                                    index <= 10 ? 'arms' : 
                                    index <= 12 ? 'torso' : 'legs';
                        const color = colors[group];

                        // –í–Ω–µ—à–Ω–∏–π –∫—Ä—É–≥
                        this.ctx.beginPath();
                        this.ctx.arc(kp.x, kp.y, 8, 0, 2 * Math.PI);
                        this.ctx.fillStyle = color;
                        this.ctx.fill();
                        
                        // –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∫—Ä—É–≥ (—É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å)
                        this.ctx.beginPath();
                        this.ctx.arc(kp.x, kp.y, 4 * kp.score, 0, 2 * Math.PI);
                        this.ctx.fillStyle = 'white';
                        this.ctx.fill();

                        // –ù–æ–º–µ—Ä —Ç–æ—á–∫–∏
                        this.ctx.fillStyle = 'white';
                        this.ctx.font = '10px Arial';
                        this.ctx.textAlign = 'center';
                        this.ctx.fillText(index.toString(), kp.x, kp.y - 12);
                    }
                });

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                this.stats.points.textContent = visiblePoints;
                this.stats.confidence.textContent = visiblePoints > 0 ? 
                    Math.round((totalConfidence / visiblePoints) * 100) + '%' : '0%';
            }

            updateStatistics(pose) {
                // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤ drawSkeleton
            }

            startDetection() {
                this.isDetecting = true;
                this.detectPose();
                this.updateStatus('üéØ –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø–æ–∑—ã –∑–∞–ø—É—â–µ–Ω–æ', 'success');
            }

            stopDetection() {
                this.isDetecting = false;
                if (this.animationId) {
                    cancelAnimationFrame(this.animationId);
                }
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                this.updateStatus('‚èπÔ∏è –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
            }

            async switchModel() {
                this.stopDetection();
                
                this.currentModel = this.currentModel === 'lite' ? 'thunder' : 'lite';
                this.updateStatus(`üîÑ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –º–æ–¥–µ–ª—å: ${this.currentModel.toUpperCase()}...`);
                
                try {
                    const modelType = this.currentModel === 'lite' ? 
                        poseDetection.movenet.modelType.SINGLEPOSE_LIGHTNING :
                        poseDetection.movenet.modelType.SINGLEPOSE_THUNDER;
                    
                    this.detector = await poseDetection.createDetector(
                        poseDetection.SupportedModels.MoveNet, 
                        { modelType, enableSmoothing: true }
                    );
                    
                    this.updateStatus(`‚úÖ –ú–æ–¥–µ–ª—å ${this.currentModel.toUpperCase()} –∑–∞–≥—Ä—É–∂–µ–Ω–∞`, 'success');
                    this.startDetection();
                    
                } catch (error) {
                    this.updateStatus('‚ùå –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –º–æ–¥–µ–ª–∏', 'error');
                }
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        const detector = new MoveNetDetector();

        document.getElementById('startButton').addEventListener('click', async () => {
            try {
                document.getElementById('startButton').disabled = true;
                await detector.setupCamera();
                
                document.getElementById('stopButton').disabled = false;
                document.getElementById('modeButton').disabled = false;
                
                detector.startDetection();
                
            } catch (error) {
                document.getElementById('startButton').disabled = false;
            }
        });

        document.getElementById('stopButton').addEventListener('click', () => {
            detector.stopDetection();
            document.getElementById('startButton').disabled = false;
            document.getElementById('stopButton').disabled = true;
            document.getElementById('modeButton').disabled = true;
        });

        document.getElementById('modeButton').addEventListener('click', () => {
            detector.switchModel();
        });

        // –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', () => detector.initialize());
    </script>
</body>
</html>